<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Administrar Slides - SIMOpro</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="css/style_admin.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>

<body class="bg-gray-100">

  <!-- Sidebar -->
  <aside class="fixed top-0 left-0 w-64 h-full bg-blue-700 text-white p-6">
    <h1 class="text-2xl font-bold mb-8">SIMOpro Admin</h1>
    <nav class="flex flex-col gap-4">
      <button onclick="showCarouselEditor()" class="w-full text-left p-4 hover:bg-blue-600">Editar Sliders</button>
      <button onclick="mostrarSeccion('crear-division')" class="w-full text-left p-4 hover:bg-blue-600">Crear División</button>
      <button onclick="mostrarSeccion('crear-servicio')" class="w-full text-left p-4 hover:bg-blue-600">Asignar Servicios</button>
      <button onclick="mostrarSeccion('crear-pagina-servicio')" class="w-full text-left p-4 hover:bg-blue-600">Crear Página de Servicio</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="ml-64 p-8 space-y-8">
    <!-- Crear División -->
    <section id="crear-division" class="hidden">
      <h2 class="text-xl font-bold mb-4">Crear División</h2>
      <div class="bg-white p-4 rounded shadow">
        <label class="block mb-2">Nombre de la división:</label>
        <input type="text" id="divisionNombre" class="w-full p-2 border rounded mb-2" placeholder="Ej: Data Center">
        <button onclick="agregarDivision()" class="bg-blue-600 text-white px-4 py-2 rounded">Agregar División</button>
      </div>
    </section>

    <!-- Crear y Asignar Servicios -->
    <section id="crear-servicio" class="hidden">
      <h2 class="text-xl font-bold mb-4">Crear y Asignar Servicios</h2>
      <div class="bg-white p-4 rounded shadow mb-4">
        <label class="block mb-2">Selecciona división:</label>
        <select id="selectDivision" class="w-full p-2 border rounded mb-2"></select>

        <label class="block mb-2">Nombre del servicio:</label>
        <input type="text" id="servicioNombre" class="w-full p-2 border rounded mb-2" placeholder="Ej: CFD pasillos">
        <button onclick="agregarServicio()" class="bg-blue-600 text-white px-4 py-2 rounded">Agregar Servicio</button>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">Servicios por división:</h3>
        <pre id="jsonPreview" class="bg-gray-100 p-3 rounded text-sm overflow-x-auto"></pre>
      </div>
    </section>

    <!-- Crear Página de Servicio -->
    <section id="crear-pagina-servicio" class="hidden">
      <h2 class="text-xl font-bold mb-4">Crear Página de Servicio</h2>
      <div class="bg-white p-4 rounded shadow">
        <label class="block mb-2">Selecciona División:</label>
        <select id="selectDivisionPagina" class="w-full p-2 border rounded mb-4"></select>

        <label class="block mb-2">Selecciona Servicio:</label>
        <select id="selectServicioPagina" class="w-full p-2 border rounded mb-4"></select>

        <label class="block mb-2">Contenido de la Página:</label>
        <div id="editor" class="bg-white border rounded h-64 mb-4"></div>

        <button onclick="guardarContenidoServicio()" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800">
          Guardar Página
        </button>
      </div>
    </section>
  </main>

  <!-- Librerías JS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="js/admin.js"></script>

  <script>
    // Editor
    const quill = new Quill('#editor', { theme: 'snow' });

    // Cargar divisiones para páginas
    function cargarDivisionesServicios() {
      const data = JSON.parse(localStorage.getItem("simopro_servicios")) || [];
      const select = document.getElementById('selectDivisionPagina');
      select.innerHTML = '<option value="">Seleccione una división</option>';
      data.forEach(div => {
        const opt = document.createElement("option");
        opt.value = div.slug;
        opt.textContent = div.division;
        select.appendChild(opt);
      });
    }

    // Cargar servicios según división seleccionada
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("selectDivisionPagina")?.addEventListener("change", function () {
        const slug = this.value;
        const data = JSON.parse(localStorage.getItem("simopro_servicios")) || [];
        const division = data.find(d => d.slug === slug);
        const select = document.getElementById("selectServicioPagina");
        select.innerHTML = '<option value="">Seleccione un servicio</option>';
        if (division) {
          division.servicios.forEach(serv => {
            const opt = document.createElement("option");
            opt.value = serv.slug;
            opt.textContent = serv.nombre;
            select.appendChild(opt);
          });
        }
      });
    });

    // Guardar HTML del servicio como descarga
    function guardarContenidoServicio() {
      const division = document.getElementById('selectDivisionPagina').value;
      const servicioSlug = document.getElementById('selectServicioPagina').value;
      const servicioNombre = document.getElementById('selectServicioPagina').selectedOptions[0]?.textContent;
      const contenidoHTML = quill.root.innerHTML;

      if (!division || !servicioSlug || !contenidoHTML.trim()) {
        alert("Por favor completa todos los campos.");
        return;
      }

      const paginas = JSON.parse(localStorage.getItem('paginasServicios')) || {};
      paginas[servicioSlug] = { division, servicio: servicioNombre, slug: servicioSlug, contenidoHTML };
      localStorage.setItem('paginasServicios', JSON.stringify(paginas));

      const html = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>${servicioNombre} - SIMOpro</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/style_admin.css">
</head>
<body class="bg-gray-100">
  <main class="p-8 max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">${servicioNombre}</h1>
    ${contenidoHTML}
  </main>
</body>
</html>`.trim();

      const blob = new Blob([html], { type: "text/html" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${servicioSlug}.html`;
      link.click();
      URL.revokeObjectURL(link.href);

      alert("Página guardada y descargada correctamente.");
    }
  </script>
</body>
</html>
